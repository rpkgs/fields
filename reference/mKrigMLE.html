<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Maximizes likelihood for the process marginal variance (sigma) and
 nugget standard deviation (tau) parameters (e.g. lambda) over a
 many covariance models or covariance parameter values. — mKrigMLE • fields</title><!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous"><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css"><script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../pkgdown.js"></script><meta property="og:title" content="Maximizes likelihood for the process marginal variance (sigma) and
 nugget standard deviation (tau) parameters (e.g. lambda) over a
 many covariance models or covariance parameter values. — mKrigMLE"><meta property="og:description" content="These function are designed to explore the likelihood surface for
different covariance parameters with the option of maximizing over
tau and sigma. They used the mKrig base are designed for computational efficiency."><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body data-spy="scroll" data-target="#toc">
    

    <div class="container template-reference-topic">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">fields</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">14.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu"><li>
      <a href="../articles/Tps.html">Tps usage illustration</a>
    </li>
    <li>
      <a href="../articles/fastTps.html">fastTps</a>
    </li>
    <li>
      <a href="../articles/predictSurface.html">predictSurface</a>
    </li>
  </ul></li>
      </ul><ul class="nav navbar-nav navbar-right"><li>
  <a href="https://github.com/dnychka/fieldsRPackage/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Maximizes likelihood for the process marginal variance (sigma) and
 nugget standard deviation (tau) parameters (e.g. lambda) over a
 many covariance models or covariance parameter values.</h1>
    
    <div class="hidden name"><code>mKrigMLE.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>These function are designed to explore the likelihood surface for
different covariance parameters with the option of maximizing over
tau and sigma. They used the <code>mKrig</code> base are designed for computational efficiency.</p>
    </div>

    <div id="ref-usage">
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">mKrigMLEGrid</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, weights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>, Z <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                       mKrig.args <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                          cov.function <span class="op">=</span> <span class="st">"stationary.cov"</span>, </span>
<span>                         cov.args <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                           na.rm <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>                         par.grid <span class="op">=</span> <span class="cn">NULL</span>, </span>
<span>                           reltol <span class="op">=</span> <span class="fl">1e-06</span>,</span>
<span>                             REML <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                             GCV  <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                       optim.args <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                 cov.params.start <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                          verbose <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                            iseed <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span>
<span>                          </span>
<span></span>
<span><span class="fu">mKrigMLEJoint</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, weights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>, Z <span class="op">=</span> <span class="cn">NULL</span>, mKrig.args</span>
<span>                 <span class="op">=</span> <span class="cn">NULL</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span>, cov.function <span class="op">=</span> <span class="st">"stationary.cov"</span>,</span>
<span>                 cov.args <span class="op">=</span> <span class="cn">NULL</span>, cov.params.start <span class="op">=</span> <span class="cn">NULL</span>, optim.args <span class="op">=</span></span>
<span>                 <span class="cn">NULL</span>, reltol <span class="op">=</span> <span class="fl">1e-06</span>, parTransform <span class="op">=</span> <span class="cn">NULL</span>, REML <span class="op">=</span></span>
<span>                 <span class="cn">FALSE</span>, GCV <span class="op">=</span> <span class="cn">FALSE</span>, hessian <span class="op">=</span> <span class="cn">FALSE</span>, iseed <span class="op">=</span> <span class="fl">303</span>,</span>
<span>     verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">profileCI</span><span class="op">(</span><span class="va">obj</span>, <span class="va">parName</span>, CIlevel <span class="op">=</span> <span class="fl">0.95</span>, REML <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> </span>
<span></span>
<span><span class="fu">mKrigJointTemp.fn</span><span class="op">(</span><span class="va">parameters</span>, <span class="va">mKrig.args</span>, <span class="va">cov.args</span>, <span class="va">parTransform</span>,</span>
<span>                 <span class="va">parNames</span>, REML <span class="op">=</span> <span class="cn">FALSE</span>, GCV <span class="op">=</span> <span class="cn">FALSE</span>, verbose <span class="op">=</span></span>
<span>                 <span class="va">verbose</span>, <span class="va">capture.env</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div id="arguments">
    <h2>Arguments</h2>
    <dl><dt>capture.env</dt>
<dd><p>For the ML objective function the frame to save the results of the evaluation. This should be the environment of the function calling optim.</p></dd>

 
<dt>CIlevel</dt>
<dd><p>Confidence level.</p></dd>

<dt>cov.function</dt>
<dd><p>The name, a text string, of the covariance function.</p></dd>

<dt>cov.args</dt>
<dd><p>The  arguments that would also be included in calls
  to the covariance function to specify the fixed part of 
  the covariance model. This is the form of a list
  E.g.<code>cov.args= list( aRange = 3.5)</code></p></dd>




<dt>cov.params.start</dt>
<dd><p>A list of initial starts for covariance parameters  to perform likelihood maximization.  The list 
  contains the names of the parameters as well as the values.
  It usually makes sense to optimize over the important lambda  parameter
  (tau^2/ sigma^2)  is most spatial applications and
  so if <code>lambda</code>  is omitted then the component
  <code>lambda = .5</code> is added to this list.</p></dd>

 
<dt>hessian</dt>
<dd><p>If TRUE return the BFGS approximation to the hessian 
matrix at convergence.</p></dd>
 

<dt>iseed</dt>
<dd><p>Sets the random seed in finding the approximate 
Monte Carlo based GCV function and the effective degrees of freedom. This will not effect random number generation outside these functions.</p></dd>


<dt>mKrig.args</dt>
<dd><p>A list of additional parameters to supply to the <code>mKrig</code> function. E.g.<code> mKrig.args= list( m=1) </code>to set the regression function to be a constant function.</p>
<p><code>mKrig</code> function that are distinct from the covariance model. 
For example <code>mKrig.args= list( m=1 )</code> will set the polynomial to be 
just a constant term (degree = m - 1 = 0).
Use  <code>mKrig.args= list( m = 0 )</code> to omit a fixed model and assume the observations have an expectation of zero.</p></dd>


<dt>na.rm</dt>
<dd><p>Remove NAs from data.</p></dd>


<dt>optim.args</dt>
<dd><p>Additional arguments that would also be included in calls
  to the optim function in joint likelihood maximization.  If 
  <code>NULL</code>, this will be set to use the "BFGS-" 
  optimization method.  See <code><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim</a></code> for more 
  details.  The default value is: 
  <code>optim.args = list(method = "BFGS", 
             control=list(fnscale = -1, 
                          ndeps = rep(log(1.1), length(cov.params.start)+1), 
                          abstol=1e-04, maxit=20))</code>
  Note that the first parameter is lambda and the others are 
  the covariance parameters in the order they are given in 
  <code>cov.params.start</code>.  Also note that the optimization 
  is performed on a transformed scale (based on the function
  <code>parTransform</code> ), and this should be taken into 
  consideration when passing arguments to <code>optim</code>.</p></dd>

<dt>parameters</dt>
<dd><p>The parameter values for evaluate the likelihood.</p></dd>


 <dt>par.grid</dt>
<dd><p>A list or data frame with components being parameters for
  different covariance models. A typical component is "aRange"
  comprising a vector of scale parameters to try. If par.grid
  is "NULL" then the covariance model is fixed at values that
  are given in ....</p></dd>


<dt>obj</dt>
<dd><p>List returnerd from <code>mKrigMLEGrid</code></p></dd>

<dt>parName</dt>
<dd><p>Name of parameter to find confidence interval.</p></dd>


<dt>parNames</dt>
<dd><p>Names of the parameters to optimize over.</p></dd>


<dt>parTransform</dt>
<dd><p>A function that maps the parameters to a scale
for optimization or
effects the inverse map from the transformed scale into the original values. See below for more details.</p></dd>


<dt>reltol</dt>
<dd><p>Optim BFGS comvergence criterion.</p></dd>


<dt>REML</dt>
<dd><p>If TRUE use REML instead of the full log likelihood.</p></dd>


<dt>GCV</dt>
<dd><p>NOT IMPLEMENTED YET!
A placeholder to implement optimization using an approximate cross-validation criterion.</p></dd>

 


<dt>verbose</dt>
<dd><p>If <code>TRUE</code> print out interesting intermediate results.</p></dd>


<dt>weights</dt>
<dd><p>Precision ( 1/variance) of each observation</p></dd>


  <dt>x</dt>
<dd>

<p>Matrix of unique spatial locations (or in print or surface 
  the returned mKrig object.)</p></dd>


  <dt>y</dt>
<dd><p>Vector or matrix of observations at spatial locations, 
  missing values are not allowed! Or in mKrig.coef a new 
  vector of observations. If y is a matrix the columns are 
  assumed to be independent observations vectors generated 
  from the same covariance and measurment error model.</p></dd>


<dt>Z</dt>
<dd><p>Linear covariates to be included in fixed part of the 
  model that are distinct from the default low order 
  polynomial in <code>x</code></p></dd>



</dl></div>
    <div id="details">
    <h2>Details</h2>
    <p>The observational model follows the same as that described in the
<code>Krig</code> function and thus the two primary covariance parameters
for a stationary model are the nugget standard deviation (tau) and
the marginal variance of the process (sigma). It is useful to
reparametrize as <code>sigma</code> and  <code> lambda = tau^2/sigma</code>.
The likelihood can be
maximized analytically over sigma and the parameters in the fixed part
of the model, this estimate of sigma can be substituted back into the
likelihood to give a expression that is just a function of lambda and
the remaining covariance parameters. This operation is called concentrating the likelhood by maximizing over a subset of parameters</p>
<p>For these kind of computations there has to be some device to identify parameters that are fixed and those that are optimized. For <code>mKrigMLEGrid</code> and <code>mKrigMLEJoint</code> the list <code>cov.args</code> should have the fixed parameters.
For example this is how to fix a lambda value in the model. The list
<code>cov.params.start</code> should be list with all parameters to optimize. The values for each component are use as the starting values. This is how the <a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim</a> function works.</p>
<p>These functions may compute  the effective degrees of freedomn 
( see <code> <a href="mKrig.html">mKrig.trace</a></code> )  using
the random tace method and so need to generate some random normals. The <code>iseed</code> arguement can be used to set the seed for this with the default being the seed  <code>303</code>. Note that the random number generation internal to these functions  is coded so that it does not effect the random number stream outside these function calls.</p>
<p>For <code>mKrigMLEJoint</code> the 
 default transformation of the parameters is set up for a log/exp transformation:</p><div class="sourceCode"><pre><code><span></span>
<span> <span class="va">parTransform</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">ptemp</span>, <span class="va">inv</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span>
<span>            <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="va">inv</span><span class="op">)</span> <span class="op">{</span></span>
<span>                <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">ptemp</span><span class="op">)</span></span>
<span>            <span class="op">}</span></span>
<span>            <span class="kw">else</span> <span class="op">{</span></span>
<span>                <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">ptemp</span><span class="op">)</span></span>
<span>            <span class="op">}</span></span>
<span>        <span class="op">}</span></span></code></pre></div>

    </div>
    <div id="value">
    <h2>Value</h2>
    

<p><strong><code>mKrigMLEGrid</code></strong> returns a list with the components:</p>
<dl><dt>summary</dt>
<dd><p>A matrix with each row giving the results of evaluating
the
 likelihood for each covariance model.</p></dd>


<dt>par.grid</dt>
<dd><p>The par.grid argument used. A matrix where rows are the combination of parameters considered.</p></dd>


<dt>call</dt>
<dd><p>The calling arguments to this function.</p></dd>


</dl><p><strong><code>mKrigMLEJoint</code></strong> returns a list with components:</p>
<dl><dt>summary</dt>
<dd><p>A vector giving the MLEs and the log likelihood at the maximum</p></dd>


<dt>lnLike.eval</dt>
<dd><p>A table containing information on all likelihood evaluations 
performed in the maximization process.</p></dd>

<dt>optimResults</dt>
<dd><p>The list returned from the optim function. Note that the parameters may be transformed values.</p></dd>


<dt>par.MLE</dt>
<dd><p>The maximum likelihood estimates.</p></dd>


<dt>parTransform</dt>
<dd><p>The transformation of the parameters used in the optimziation.</p></dd>


</dl></div>
    <div id="references">
    <h2>References</h2>
    <p><a href="https://github.com/dnychka/fieldsRPackage" class="external-link">https://github.com/dnychka/fieldsRPackage</a></p>
    </div>
    <div id="author">
    <h2>Author</h2>
    <p><!-- %%  ~~who you are~~ -->
Douglas W. Nychka, John Paige</p>
    </div>
    <div id="see-also">
    <h2>See also</h2>
    <div class="dont-index"><p><!-- %% ~~objects to See Also as \code{\link{help}}, ~~~ -->
<code><a href="mKrig.html">mKrig</a></code>
<code><a href="Krig.html">Krig</a></code>
<code><a href="exp.cov.html">stationary.cov</a></code>
<code><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim</a></code></p></div>
    </div>

    <div id="ref-examples">
    <h2>Examples</h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span></span></span>
<span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span><span class="co">#perform joint likelihood maximization over lambda and aRange. </span></span></span>
<span class="r-in"><span><span class="co"># NOTE: optim can get a bad answer with poor initial starts.</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">ozone2</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">s</span><span class="op">&lt;-</span> <span class="va">ozone2</span><span class="op">$</span><span class="va">lon.lat</span></span></span>
<span class="r-in"><span>  <span class="va">z</span><span class="op">&lt;-</span> <span class="va">ozone2</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="fl">16</span>,<span class="op">]</span></span></span>
<span class="r-in"><span>  <span class="va">gridList</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span> aRange <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span> <span class="fl">.4</span>,<span class="fl">1.0</span>,length.out<span class="op">=</span><span class="fl">20</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>                 lambda <span class="op">=</span> <span class="fl">10</span><span class="op">**</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span> <span class="op">-</span><span class="fl">1.5</span>,<span class="fl">0</span>,length.out<span class="op">=</span><span class="fl">20</span><span class="op">)</span></span></span>
<span class="r-in"><span>                 <span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">par.grid</span><span class="op">&lt;-</span> <span class="fu"><a href="grid.list.html">make.surface.grid</a></span><span class="op">(</span> <span class="va">gridList</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">out</span><span class="op">&lt;-</span> <span class="fu">mKrigMLEGrid</span><span class="op">(</span> <span class="va">s</span>,<span class="va">z</span>, par.grid<span class="op">=</span><span class="va">par.grid</span>,</span></span>
<span class="r-in"><span>                          cov.args<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>smoothness<span class="op">=</span><span class="fl">1.0</span>,</span></span>
<span class="r-in"><span>                                     Covariance<span class="op">=</span><span class="st">"Matern"</span> <span class="op">)</span></span></span>
<span class="r-in"><span>                          <span class="op">)</span>   </span></span>
<span class="r-in"><span>  <span class="va">outP</span><span class="op">&lt;-</span> <span class="fu"><a href="as.surface.html">as.surface</a></span><span class="op">(</span> <span class="va">par.grid</span>, <span class="va">out</span><span class="op">$</span><span class="va">summary</span><span class="op">[</span>,<span class="st">"lnProfileLike.FULL"</span><span class="op">]</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="image.plot.html">image.plot</a></span><span class="op">(</span> <span class="va">outP</span><span class="op">$</span><span class="va">x</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log10</a></span><span class="op">(</span><span class="va">outP</span><span class="op">$</span><span class="va">y</span><span class="op">)</span>,<span class="va">outP</span><span class="op">$</span><span class="va">z</span>,</span></span>
<span class="r-in"><span>               xlab<span class="op">=</span><span class="st">"aRange"</span>, ylab<span class="op">=</span><span class="st">"log10 lambda"</span><span class="op">)</span></span></span>
<span class="r-in"><span>               </span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span> </span></span>
<span class="r-in"><span> <span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="va">N</span><span class="op">&lt;-</span> <span class="fl">50</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">x</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">N</span><span class="op">)</span>, <span class="va">N</span>,<span class="fl">2</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">aRange</span><span class="op">&lt;-</span> <span class="fl">.2</span></span></span>
<span class="r-in"><span>  <span class="va">Sigma</span><span class="op">&lt;-</span>  <span class="fu"><a href="Exponential.html">Matern</a></span><span class="op">(</span> <span class="fu"><a href="rdist.html">rdist</a></span><span class="op">(</span><span class="va">x</span>,<span class="va">x</span><span class="op">)</span><span class="op">/</span><span class="va">aRange</span> , smoothness<span class="op">=</span><span class="fl">1.0</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">Sigma.5</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/chol.html" class="external-link">chol</a></span><span class="op">(</span> <span class="va">Sigma</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">tau</span><span class="op">&lt;-</span> <span class="fl">.1</span></span></span>
<span class="r-in"><span>  <span class="co">#  250 independent spatial data sets but a common covariance function </span></span></span>
<span class="r-in"><span>  <span class="co">#    -- there is little overhead in</span></span></span>
<span class="r-in"><span>  <span class="co">#        MLE across independent realizations and a good test of code validity.</span></span></span>
<span class="r-in"><span>  <span class="va">M</span><span class="op">&lt;-</span><span class="fl">250</span></span></span>
<span class="r-in"><span>  <span class="va">F.true</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span> <span class="va">Sigma.5</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">*</span><span class="va">M</span><span class="op">)</span>, <span class="va">N</span>,<span class="va">M</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">Y</span><span class="op">&lt;-</span>  <span class="va">F.true</span> <span class="op">+</span>  <span class="va">tau</span><span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">*</span><span class="va">M</span><span class="op">)</span>, <span class="va">N</span>,<span class="va">M</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># find MLE for lambda with grid of ranges </span></span></span>
<span class="r-in"><span><span class="co"># and smoothness fixed in Matern                     </span></span></span>
<span class="r-in"><span> <span class="va">par.grid</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span> aRange<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span> <span class="fl">.1</span>,<span class="fl">.35</span>,,<span class="fl">8</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">obj1b</span><span class="op">&lt;-</span> <span class="fu">mKrigMLEGrid</span><span class="op">(</span> <span class="va">x</span>,<span class="va">Y</span>,</span></span>
<span class="r-in"><span>     cov.args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>Covariance<span class="op">=</span><span class="st">"Matern"</span>, smoothness<span class="op">=</span><span class="fl">1.0</span><span class="op">)</span>, </span></span>
<span class="r-in"><span>     cov.params.start<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span> lambda <span class="op">=</span> <span class="fl">.5</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>        par.grid <span class="op">=</span> <span class="va">par.grid</span></span></span>
<span class="r-in"><span>                    <span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">obj1b</span><span class="op">$</span><span class="va">summary</span> <span class="co"># take a look</span></span></span>
<span class="r-in"><span><span class="co"># profile over aRange</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span> <span class="va">par.grid</span><span class="op">$</span><span class="va">aRange</span>, <span class="va">obj1b</span><span class="op">$</span><span class="va">summary</span><span class="op">[</span>,<span class="st">"lnProfileLike.FULL"</span><span class="op">]</span>,</span></span>
<span class="r-in"><span>    type<span class="op">=</span><span class="st">"b"</span>, log<span class="op">=</span><span class="st">"x"</span><span class="op">)</span></span></span>
<span class="r-in"><span> <span class="op">}</span></span></span>
<span class="r-in"><span>  <span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span><span class="co"># m=0 is a simple switch to indicate _no_ fixed spatial drift</span></span></span>
<span class="r-in"><span><span class="co"># (the default and highly recommended  is linear drift, m=2). </span></span></span>
<span class="r-in"><span><span class="co"># However, m=0 results in MLEs that are less biased, being the correct model</span></span></span>
<span class="r-in"><span><span class="co"># -- in fact it nails it !</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="va">obj1a</span><span class="op">&lt;-</span> <span class="fu">mKrigMLEJoint</span><span class="op">(</span><span class="va">x</span>,<span class="va">Y</span>, </span></span>
<span class="r-in"><span>                    cov.args<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>Covariance<span class="op">=</span><span class="st">"Matern"</span>, smoothness<span class="op">=</span><span class="fl">1.0</span><span class="op">)</span>, </span></span>
<span class="r-in"><span>                    cov.params.start<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>aRange <span class="op">=</span><span class="fl">.5</span>, lambda <span class="op">=</span> <span class="fl">.5</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>                     mKrig.args<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span> m<span class="op">=</span><span class="fl">0</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span> </span></span>
<span class="r-in"><span> <span class="fu"><a href="fields.tests.html">test.for.zero</a></span><span class="op">(</span> <span class="va">obj1a</span><span class="op">$</span><span class="va">summary</span><span class="op">[</span><span class="st">"tau"</span><span class="op">]</span>, <span class="va">tau</span>, tol<span class="op">=</span><span class="fl">.007</span><span class="op">)</span></span></span>
<span class="r-in"><span> <span class="fu"><a href="fields.tests.html">test.for.zero</a></span><span class="op">(</span> <span class="va">obj1a</span><span class="op">$</span><span class="va">summary</span><span class="op">[</span><span class="st">"aRange"</span><span class="op">]</span>, <span class="va">aRange</span>, tol<span class="op">=</span><span class="fl">.015</span><span class="op">)</span></span></span>
<span class="r-in"><span> </span></span>
<span class="r-in"><span><span class="op">}</span> </span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">##########################################################################</span></span></span>
<span class="r-in"><span><span class="co"># A bootstrap example</span></span></span>
<span class="r-in"><span><span class="co"># Here is a example of a more efficient (but less robust) bootstrap using </span></span></span>
<span class="r-in"><span><span class="co"># mKrigMLEJoint and tuned starting values</span></span></span>
<span class="r-in"><span><span class="co">##########################################################################</span></span></span>
<span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span> <span class="va">ozone2</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">obj</span><span class="op">&lt;-</span> <span class="fu"><a href="spatialProcess.html">spatialProcess</a></span><span class="op">(</span> <span class="va">ozone2</span><span class="op">$</span><span class="va">lon.lat</span>,<span class="va">ozone2</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="fl">16</span>,<span class="op">]</span> <span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">######### boot strap </span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">M</span><span class="op">&lt;-</span> <span class="fl">25</span></span></span>
<span class="r-in"><span><span class="co"># create M indepedent copies of the observation vector</span></span></span>
<span class="r-in"><span>  <span class="va">ySynthetic</span><span class="op">&lt;-</span> <span class="fu"><a href="sim.Krig.html">simSpatialData</a></span><span class="op">(</span> <span class="va">obj</span>, <span class="va">M</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">bootSummary</span><span class="op">&lt;-</span> <span class="cn">NULL</span></span></span>
<span class="r-in"><span>  </span></span>
<span class="r-in"><span> <span class="va">aRangeMLE</span><span class="op">&lt;-</span> <span class="va">obj</span><span class="op">$</span><span class="va">summary</span><span class="op">[</span><span class="st">"aRange"</span><span class="op">]</span></span></span>
<span class="r-in"><span> <span class="va">lambdaMLE</span><span class="op">&lt;-</span> <span class="va">obj</span><span class="op">$</span><span class="va">summary</span><span class="op">[</span><span class="st">"lambda"</span><span class="op">]</span></span></span>
<span class="r-in"><span> </span></span>
<span class="r-in"><span>  <span class="kw">for</span><span class="op">(</span>  <span class="va">k</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">M</span><span class="op">)</span><span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span> <span class="va">k</span>, <span class="st">" "</span> <span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># here the MLEs are found using the easy top level level wrapper</span></span></span>
<span class="r-in"><span><span class="co"># see mKrigMLEJoint for a more efficient strategy</span></span></span>
<span class="r-in"><span>  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu">mKrigMLEJoint</span><span class="op">(</span><span class="va">obj</span><span class="op">$</span><span class="va">x</span>, <span class="va">ySynthetic</span><span class="op">[</span>,<span class="va">k</span><span class="op">]</span>,</span></span>
<span class="r-in"><span>                 weights <span class="op">=</span> <span class="va">obj</span><span class="op">$</span><span class="va">weights</span>,</span></span>
<span class="r-in"><span>              mKrig.args <span class="op">=</span> <span class="va">obj</span><span class="op">$</span><span class="va">mKrig.args</span>,</span></span>
<span class="r-in"><span>                 cov.function <span class="op">=</span> <span class="va">obj</span><span class="op">$</span><span class="va">cov.function.name</span>,</span></span>
<span class="r-in"><span>                cov.args <span class="op">=</span> <span class="va">obj</span><span class="op">$</span><span class="va">cov.args</span>, </span></span>
<span class="r-in"><span>        cov.params.start <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span> aRange <span class="op">=</span> <span class="va">aRangeMLE</span>,</span></span>
<span class="r-in"><span>                                lambda <span class="op">=</span> <span class="va">lambdaMLE</span><span class="op">)</span></span></span>
<span class="r-in"><span>                      <span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">newSummary</span><span class="op">&lt;-</span> <span class="va">out</span><span class="op">$</span><span class="va">summary</span></span></span>
<span class="r-in"><span>  <span class="va">bootSummary</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span> <span class="va">bootSummary</span>, <span class="va">newSummary</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="op">}</span></span></span>
<span class="r-in"><span>  </span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span>  <span class="st">" "</span>, fill<span class="op">=</span><span class="cn">TRUE</span> <span class="op">)</span></span></span>
<span class="r-in"><span>  </span></span>
<span class="r-in"><span>  <span class="va">obj</span><span class="op">$</span><span class="va">summary</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="stats.html">stats</a></span><span class="op">(</span> <span class="va">bootSummary</span><span class="op">)</span></span></span>
<span class="r-in"><span>  </span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span><span class="co">#perform joint likelihood maximization over lambda, aRange, and smoothness.  </span></span></span>
<span class="r-in"><span><span class="co">#note: finding smoothness is not a robust optimiztion </span></span></span>
<span class="r-in"><span><span class="co">#      can get a bad answer with poor initial guesses.</span></span></span>
<span class="r-in"><span><span class="va">obj2</span><span class="op">&lt;-</span> <span class="fu">mKrigMLEJoint</span><span class="op">(</span><span class="va">x</span>,<span class="va">Y</span>, </span></span>
<span class="r-in"><span>                      cov.args<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>Covariance<span class="op">=</span><span class="st">"Matern"</span><span class="op">)</span>, </span></span>
<span class="r-in"><span>                      cov.params.start<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span> aRange <span class="op">=</span> <span class="fl">.18</span>,</span></span>
<span class="r-in"><span>                                         smoothness <span class="op">=</span> <span class="fl">1.1</span>,</span></span>
<span class="r-in"><span>                                             lambda <span class="op">=</span> <span class="fl">.08</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>                       <span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">#look at lnLikelihood  evaluations</span></span></span>
<span class="r-in"><span><span class="va">obj2</span><span class="op">$</span><span class="va">summary</span></span></span>
<span class="r-in"><span><span class="co">#compare to REML</span></span></span>
<span class="r-in"><span><span class="va">obj3</span><span class="op">&lt;-</span> <span class="fu">mKrigMLEJoint</span><span class="op">(</span><span class="va">x</span>,<span class="va">Y</span>, </span></span>
<span class="r-in"><span>                      cov.args<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>Covariance<span class="op">=</span><span class="st">"Matern"</span><span class="op">)</span>, </span></span>
<span class="r-in"><span>                      cov.params.start<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>aRange <span class="op">=</span> <span class="fl">.18</span>, </span></span>
<span class="r-in"><span>                                       smoothness <span class="op">=</span> <span class="fl">1.1</span>,</span></span>
<span class="r-in"><span>                                           lambda <span class="op">=</span> <span class="fl">.08</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>                       , REML<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">obj3</span><span class="op">$</span><span class="va">summary</span>                      </span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span><span class="co">#look at lnLikelihood  evaluations</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># check convergence of MLE to true fit with no fixed part</span></span></span>
<span class="r-in"><span><span class="co"># </span></span></span>
<span class="r-in"><span><span class="va">obj4</span><span class="op">&lt;-</span> <span class="fu">mKrigMLEJoint</span><span class="op">(</span><span class="va">x</span>,<span class="va">Y</span>, </span></span>
<span class="r-in"><span>                      mKrig.args<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span> m<span class="op">=</span><span class="fl">0</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>                      cov.args<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>Covariance<span class="op">=</span><span class="st">"Matern"</span>, smoothness<span class="op">=</span><span class="fl">1</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>                      cov.params.start<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>aRange<span class="op">=</span><span class="fl">.2</span>, lambda<span class="op">=</span><span class="fl">.1</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>                       REML<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co">#look at lnLikelihood  evaluations</span></span></span>
<span class="r-in"><span><span class="va">obj4</span><span class="op">$</span><span class="va">summary</span></span></span>
<span class="r-in"><span><span class="co"># nails it!</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
</code></pre></div>
    </div>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top"><h2 data-toc-skip>Contents</h2>
    </nav></div>
</div>


      <footer><div class="copyright">
  <p></p><p>Developed by Douglas Nychka, Reinhard Furrer, John Paige, Stephan Sain, Florian Gerber, Matthew Iverson.</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer></div>

  


  

  </body></html>

