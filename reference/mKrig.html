<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>"micro Krig"  Spatial process estimate of a curve or surface, 
"kriging" with a known covariance function. — mKrig • fields</title><!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous"><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css"><script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../pkgdown.js"></script><meta property="og:title" content="" micro krig spatial process estimate of a curve or surface with known covariance function. mkrig><meta property="og:description" content="This is a simple version of the Krig function that is 
optimized for large data sets, sparse linear algebra, and a clear exposition of the
computations. Lambda, the smoothing parameter must be fixed. 
This function is called higher level functions for maximum likelihood estimates of 
covariance paramters."><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body data-spy="scroll" data-target="#toc">
    

    <div class="container template-reference-topic">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">fields</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">14.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu"><li>
      <a href="../articles/Tps.html">Tps usage illustration</a>
    </li>
    <li>
      <a href="../articles/fastTps.html">fastTps</a>
    </li>
    <li>
      <a href="../articles/predictSurface.html">predictSurface</a>
    </li>
  </ul></li>
      </ul><ul class="nav navbar-nav navbar-right"><li>
  <a href="https://github.com/dnychka/fieldsRPackage/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>"micro Krig"  Spatial process estimate of a curve or surface, 
"kriging" with a known covariance function.</h1>
    
    <div class="hidden name"><code>mKrig.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>This is a simple version of the Krig function that is 
optimized for large data sets, sparse linear algebra, and a clear exposition of the
computations. Lambda, the smoothing parameter must be fixed. 
This function is called higher level functions for maximum likelihood estimates of 
covariance paramters.</p>
    </div>

    <div id="ref-usage">
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">mKrig</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, weights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>, Z <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                 cov.function <span class="op">=</span> <span class="st">"stationary.cov"</span>, cov.args <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                 lambda <span class="op">=</span> <span class="cn">NA</span>, m <span class="op">=</span> <span class="fl">2</span>, chol.args <span class="op">=</span> <span class="cn">NULL</span>, find.trA <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                 NtrA <span class="op">=</span> <span class="fl">20</span>, iseed <span class="op">=</span> <span class="cn">NA</span>,  na.rm <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                 collapseFixedEffect <span class="op">=</span> <span class="cn">TRUE</span>, tau <span class="op">=</span> <span class="cn">NA</span>, sigma2 <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>                 <span class="va">...</span><span class="op">)</span></span>
<span><span class="co"># S3 method for mKrig</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span> <span class="va">object</span>, xnew<span class="op">=</span><span class="cn">NULL</span>,ynew<span class="op">=</span><span class="cn">NULL</span>, grid.list <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>derivative<span class="op">=</span><span class="fl">0</span>,</span>
<span>Z<span class="op">=</span><span class="cn">NULL</span>,drop.Z<span class="op">=</span><span class="cn">FALSE</span>,just.fixed<span class="op">=</span><span class="cn">FALSE</span>,</span>
<span>collapseFixedEffect <span class="op">=</span> <span class="va">object</span><span class="op">$</span><span class="va">collapseFixedEffect</span>, <span class="va">...</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># S3 method for mKrig</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">object</span>, <span class="va">...</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># S3 method for mKrig</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span> <span class="va">x</span>, digits<span class="op">=</span><span class="fl">4</span>,<span class="va">...</span> <span class="op">)</span></span>
<span><span class="co"># S3 method for mKrigSummary</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span> <span class="va">x</span>, digits<span class="op">=</span><span class="fl">4</span>,<span class="va">...</span> <span class="op">)</span></span>
<span></span>
<span><span class="fu">mKrig.coef</span><span class="op">(</span><span class="va">object</span>, <span class="va">y</span>, collapseFixedEffect<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">mKrig.trace</span><span class="op">(</span> <span class="va">object</span>, <span class="va">iseed</span>, <span class="va">NtrA</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">mKrigCheckXY</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">weights</span>, <span class="va">Z</span>, <span class="va">na.rm</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div id="arguments">
    <h2>Arguments</h2>
    <dl><dt>collapseFixedEffect</dt>
<dd><p>If replicated fields are given to mKrig (i.e.
<code>y</code> has more than one column) there is the choice of estimating the
fixed effect coefficients (<code>d</code> in the returned object) separately
for each replicate or pooling across replicates and deriving a single
estimate. If <code>collapseFixedEffect</code> is TRUE (default) the estimates are
pooled.</p></dd>

  
<dt>chol.args</dt>
<dd><p>A list of optional arguments (pivot, nnzR) that will
be used with the call to the cholesky decomposition. Pivoting is done
by default to make use of sparse matrices when they are
generated. This argument is useful in some cases for sparse covariance
functions to reset the memory parameter nnzR.  (See example below.)</p></dd>


<dt>cov.args</dt>
<dd><p>A list of optional arguments that will be used in
  calls to the covariance function.</p></dd>


<dt>cov.function</dt>
<dd><p>The name, a text string of the covariance function.</p></dd>


<dt>derivative</dt>
<dd><p>If zero the surface will be evaluated. If not zero
  the matrix of partial derivatives will be computed.</p></dd>


<dt>digits</dt>
<dd><p>Number of significant digits used in printed output.</p></dd>


<dt>drop.Z</dt>
<dd><p>If true the fixed part will only be evaluated at the
polynomial part of the fixed model. The contribution from the other
covariates will be omitted.</p></dd>


<dt>find.trA</dt>
<dd><p>If TRUE will estimate the effective degrees of freedom using 
  a simple Monte Carlo method. This will add to the computational 
  burden by approximately NtrA solutions of the linear system but 
  the cholesky decomposition is reused.</p></dd>


<dt>grid.list</dt>
<dd><p>A grid.list to evaluate the surface in place of specifying 
  arbitrary locations.</p></dd>


<dt>iseed</dt>
<dd><p>Random seed ( using <code>set.seed(iseed)</code>) used to generate 
  iid normals for Monte Carlo estimate of the trace. Set this to an integer to insure the same random draws are used to compute the approximate trace and be consistent across different values of the covariance parameters.</p></dd>


<dt>just.fixed</dt>
<dd><p>If TRUE only the predictions for the fixed part of
  the model will be evaluted.</p></dd>

  
<dt>lambda</dt>
<dd><p>Smoothing parameter or equivalently the ratio between 
  the nugget and process varainces.</p></dd>


<dt>m</dt>
<dd><p>The degree of the polynomial used in the fixed part.
This is follows the thin plate spline convention that the degree is m-1. 
Default is m=2 for a linear function, m=1 a constant and,
as an quick logical switch, m=0 will result in no fixed part in the spatial model.</p></dd>


<dt>na.rm</dt>
<dd><p>If TRUE NAs in y are omitted along with corresonding rows of x.</p></dd>


<dt>NtrA</dt>
<dd><p>Number of Monte Carlo samples for the trace. But if NtrA is 
  greater than or equal to the number of observations the trace 
  is computed exactly.</p></dd>


<dt>object</dt>
<dd><p>Object returned by mKrig. (Same as "x"
  in the print function.)</p></dd>

  
<dt>sigma2</dt>
<dd><p>Value of the process variance.</p></dd>
  

<dt>tau</dt>
<dd><p>Value of the measurment error standard deviation.</p></dd>

  
<dt>weights</dt>
<dd><p>Precision ( 1/variance) of each observation</p></dd>


<dt>x</dt>
<dd><p>Matrix of unique spatial locations (or in print or surface 
the returned mKrig object.)</p></dd>


<dt>xnew</dt>
<dd><p>Locations for predictions.</p></dd>


<dt>y</dt>
<dd><p>Vector or matrix of observations at spatial locations, 
  missing values are not allowed! Or in mKrig.coef a new 
  vector of observations. If y is a matrix the columns are 
  assumed to be independent replicates of the spatial field.  I.e.
  observation vectors generated 
  from the same covariance and measurment error model but 
  independent from each other.</p></dd>


<dt>ynew</dt>
<dd><p>New observation vector. <code>mKrig</code> will reuse matrix
  decompositions and find the new fit to these data.</p></dd>


<dt>Z</dt>
<dd><p>Linear covariates to be included in fixed part of the 
  model that are distinct from the default low order 
  polynomial in <code>x</code>. (NOTE the order of the polynomial
  determined by <code>m</code>)</p></dd>


<dt>...</dt>
<dd><p>In <code>mKrig</code> and <code>predict</code> additional arguments
that will be passed to the covariance function.</p></dd>


</dl></div>
    <div id="details">
    <h2>Details</h2>
    <p>This function is an abridged version of Krig and uses a more direct
 computation for the linear algebra that faciliates compactly supported
 covariance functions. The m stand for micro
and 
done for a fixed lambda parameter and other covariance parameters (e.g. aRange) and for unique spatial locations. 
This is also the basic computational element of the top level <code><a href="spatialProcess.html">spatialProcess</a> </code> function for finding MLEs. 
See the source code for a commented version that described the computation.
These restrictions simplify the code for reading. Note that also
little checking is done and the spatial locations are not transformed
before the estimation.</p>
<p><strong>Repeated locations</strong> To keep the coding simple <code>x</code> must be a set of unique locations. When there are multiple observations at a location -- also known as replicated locations -- one strategy is to use the average spatial value for this location in place of mulitple observations.  One can also adjust the weights accordingly  for this location if that makes sense. To do this use the function 
<code><a href="Krig.replicates.html">Krig.replicates</a></code>. 
For example</p>
<div class="sourceCode"><pre><code><span></span>
<span> <span class="va">out</span><span class="op">&lt;-</span> <span class="fu"><a href="../reference/Krig.replicates.html">Krig.replicates</a></span><span class="op">(</span> x<span class="op">=</span><span class="va">x</span>, y<span class="op">=</span><span class="va">y</span><span class="op">)</span></span></code></pre></div>

<p>and <code>out$xM, out$yM, out$weightsM</code> will be the unique locations with averaged values and the number of observations.</p>

<div class="sourceCode"><pre><code><span></span>
<span> <span class="va">out</span><span class="op">&lt;-</span> <span class="fu"><a href="../reference/Krig.replicates.html">Krig.replicates</a></span><span class="op">(</span> x<span class="op">=</span><span class="va">x</span>, y<span class="op">=</span><span class="va">y</span>, weights<span class="op">=</span> <span class="va">weights</span><span class="op">)</span></span></code></pre></div>

<p>will also combine the weight vector  based on the  replications and be returned as  <code>out$weightsM</code>.</p>




<p><strong>Multiple fields</strong>  Because most of the operations are linear
algebra this code has been written to handle multiple data
sets. Specifically, if the spatial model is the same except for
different observed values (the y's), one can pass <code>y</code> as a matrix
and the computations are done efficiently for each set.
The likelihood across all replicates is combined and denoted with  <code>FULL</code> at the end. Also note the <code>collapseFixedEffects</code> switch to determine if the regression part is found seperately for each replicate or combined into a single model. Note that
this is not a multivariate spatial model  -- just an efficient computation
over several data vectors without explicit looping. A big difference in
the computations is that an exact expression for the trace of the
smoothing matrix is (trace A(lambda)) is computationally expensive and
a Monte Carlo approximation is supplied instead.</p>
<p><strong>Supporting functions</strong></p>
<p>See <code>predictSE.mKrig</code> for prediction standard errors and 
<code>sim.mKrig.approx</code> to quantify the uncertainty in the estimated function using conditional 
simulation.</p>
<p><code>predict.mKrig</code> will evaluate the derivatives of the estimated
function if derivatives are supported in the covariance function.  For
example the wendland.cov function supports derivatives.</p>

<p><code>summary.mKrig</code> creates a list of class <code>mKrigSummary</code> along with a table of standard errors for the fixed linear parameters.</p>
<p><code>print.mKrigSummary</code> prints the  <code>mKrigSummary</code> object and adds some more explanation about the model and results</p>
<p><code>print.mKrig</code> prints a summary for the <code>mKrig</code> object that the combines the summary and  print methods.</p>

<p><code>mKrig.coef</code> finds "beta"" and "c"  coefficients representing the
solution using the previous cholesky decomposition but  for a new data
vector. This is used in computing the prediction standard error in
predictSE.mKrig and can also be used to evalute the estimate
efficiently at new vectors of observations provided the locations, fixed part,  and
the covariance matrix  all remain  the same .</p>
<p><strong>Sparse covariance functions</strong> Sparse matrix methods are handled through overloading the usual linear
algebra functions with sparse versions. But to take advantage of some
additional options in the sparse methods the list argument chol.args
is a device for changing some default values. The most important of
these is <code>nnzR</code>, the number of nonzero elements anticipated in
the Cholesky factorization of the postive definite linear system used
to solve for the basis coefficients. The sparse of this system is
essentially the same as the covariance matrix evalauted at the
observed locations.  As an example of resetting <code>nzR</code> to 450000
one would use the following argument for chol.args in mKrig:</p>
<p><code> chol.args=list(pivot=TRUE,memory=list(nnzR= 450000))</code></p>
<p><strong>Approximation trace estimate</strong>
<code>mKrig.trace</code> This is an internal function called by <code>mKrig</code>
to estimate the effective degrees of freedom.  The Kriging surface
estimate at the data locations is a linear function of the data and
can be represented as A(lambda)y.  The trace of A is one useful
measure of the effective degrees of freedom used in the surface
representation. In particular this figures into the GCV estimate of
the smoothing parameter.  It is computationally intensive to find the
trace explicitly but there is a simple Monte Carlo estimate that is
often very useful.  If E is a vector of iid N(0,1) random variables
then the trace of A is the expected value of t(E)AE. Note that AE is
simply predicting a surface at the data location using the synthetic
observation vector E. This is done for <code>NtrA</code> independent N(0,1)
vectors and the mean and standard deviation are reported in the
<code>mKrig</code> summary.  Typically as the number of observations is
increased this estimate becomse more accurate. If NtrA is as large as
the number of observations (<code>np</code>) then the algorithm switches to
finding the trace exactly based on applying A to <code>np</code> unit
vectors.</p>
    </div>
    <div id="value">
    <h2>Value</h2>
    <dl><dt>summary</dt>
<dd><p>A named array with the values of  covariance parameters
 and log likelihoods.</p></dd>


  <dt>beta</dt>
<dd><p>Coefficients of the polynomial fixed part and if present
  the covariates (Z).To determine which is which the logical vector
  ind.drift also part of this object is TRUE for the polynomial
  part.</p></dd>


  <dt>c.coef</dt>
<dd><p>Coefficients of the nonparametric part.</p></dd>


  <dt>nt</dt>
<dd><p>Dimension of fixed part.</p></dd>


  <dt>np</dt>
<dd><p>Dimension of c.coef.</p></dd>


  <dt>nZ</dt>
<dd><p>Number of columns of Z covariate matrix (can be zero).</p></dd>


   <dt>ind.drift</dt>
<dd><p>Logical vector that indicates polynomial
   coefficients in the <code>d</code> coefficients vector. This is helpful
   to distguish between polynomial part and the extra covariates
   coefficients associated with Z.</p></dd>

 
 <dt>lambda.fixed</dt>
<dd><p>The fixed lambda value</p></dd>


  <dt>x</dt>
<dd><p>Spatial locations used for fitting.</p></dd>


  <dt>knots</dt>
<dd><p>The same as x</p></dd>


  <dt>cov.function.name</dt>
<dd><p>Name of covariance function used.</p></dd>


 <dt>args</dt>
<dd><p>A list with all the covariance arguments that were
 specified in the call.</p></dd>


 <dt>m</dt>
<dd><p>Order of fixed part polynomial.</p></dd>


  <dt>chol.args</dt>
<dd><p>A list with all the cholesky arguments that were
         specified in the call.</p></dd>


 <dt>call</dt>
<dd><p>A copy of the call to mKrig.</p></dd>


 <dt>non.zero.entries</dt>
<dd><p>Number of nonzero entries in the covariance
matrix for the process at the observation locations.</p></dd>


 
 <dt>lnDetCov</dt>
<dd><p>Log determinant of the covariance matrix for the
  observations having factored out sigma.</p></dd>


 <dt>Omega</dt>
<dd><p>GLS covariance for the estimated parameters in the fixed
part of the model (d coefficients0.</p></dd>


 <dt>qr.VT, Mc</dt>
<dd><p>QR and cholesky matrix decompositions needed to
recompute the estimate for new observation vectors.</p></dd>


 <dt>fitted.values, residuals</dt>
<dd><p>Usual predictions from fit.</p></dd>


 <dt>eff.df</dt>
<dd><p>Estimate of effective degrees of freedom. Either the
mean of the Monte Carlo sample or the exact value.</p></dd>


 <dt>trA.info</dt>
<dd><p>If NtrA ids less than <code>np</code> then the individual
members of the Monte Carlo sample and <code>sd(trA.info)/ sqrt(NtrA)</code>
is an estimate of the standard error. If NtrA is greater than or equal
to <code>np</code> then these are the diagonal elements of A(lamdba).</p></dd>


 <dt>GCV</dt>
<dd><p>Estimated value of the GCV function.</p></dd>


 <dt>GCV.info</dt>
<dd><p>Monte Carlo sample of GCV functions</p></dd>


</dl></div>
    <div id="author">
    <h2>Author</h2>
    <p>Doug Nychka, Reinhard Furrer, John Paige</p>
    </div>
    <div id="see-also">
    <h2>See also</h2>
    <div class="dont-index"><p>Krig, surface.mKrig, Tps, fastTps, predictSurface, predictSE.mKrig, sim.mKrig.approx, 
  <code> <a href="fields.grid.html">mKrig.grid</a></code></p></div>
    </div>
    <div id="references">
    <h2>References</h2>
    <p><a href="https://github.com/dnychka/fieldsRPackage" class="external-link">https://github.com/dnychka/fieldsRPackage</a></p>
    </div>

    <div id="ref-examples">
    <h2>Examples</h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="co">#</span></span></span>
<span class="r-in"><span><span class="co"># Midwest ozone data  'day 16' stripped of missings </span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span> <span class="va">ozone2</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">y</span><span class="op">&lt;-</span> <span class="va">ozone2</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="fl">16</span>,<span class="op">]</span></span></span>
<span class="r-in"><span>  <span class="va">good</span><span class="op">&lt;-</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span> <span class="va">y</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">y</span><span class="op">&lt;-</span><span class="va">y</span><span class="op">[</span><span class="va">good</span><span class="op">]</span></span></span>
<span class="r-in"><span>  <span class="va">x</span><span class="op">&lt;-</span> <span class="va">ozone2</span><span class="op">$</span><span class="va">lon.lat</span><span class="op">[</span><span class="va">good</span>,<span class="op">]</span></span></span>
<span class="r-in"><span><span class="co"># nearly interpolate using defaults (Exponential covariance range = 2.0)</span></span></span>
<span class="r-in"><span><span class="co"># see also mKrigMLEGrid to choose lambda by maxmimum likelihood</span></span></span>
<span class="r-in"><span>  <span class="va">out</span><span class="op">&lt;-</span> <span class="fu">mKrig</span><span class="op">(</span> <span class="va">x</span>,<span class="va">y</span>, aRange <span class="op">=</span> <span class="fl">2.0</span>, lambda<span class="op">=</span><span class="fl">.01</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">out.p</span><span class="op">&lt;-</span> <span class="fu"><a href="predictSurface.html">predictSurface</a></span><span class="op">(</span> <span class="va">out</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="fields-internal.html">surface</a></span><span class="op">(</span> <span class="va">out.p</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="mKrig-1.png" alt="" width="700" height="433"></span>
<span class="r-in"><span><span class="co">#</span></span></span>
<span class="r-in"><span><span class="co"># NOTE this should be identical to </span></span></span>
<span class="r-in"><span><span class="co"># Krig( x,y, aRange=2.0, lambda=.01) </span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">##############################################################################</span></span></span>
<span class="r-in"><span><span class="co"># an example using a "Z" covariate and the Matern family</span></span></span>
<span class="r-in"><span><span class="co">#  again see mKrigMLEGrid to choose parameters by MLE.</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">COmonthlyMet</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">yCO</span><span class="op">&lt;-</span> <span class="va">CO.tmin.MAM.climate</span></span></span>
<span class="r-in"><span><span class="va">good</span><span class="op">&lt;-</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span> <span class="va">yCO</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">yCO</span><span class="op">&lt;-</span><span class="va">yCO</span><span class="op">[</span><span class="va">good</span><span class="op">]</span></span></span>
<span class="r-in"><span><span class="va">xCO</span><span class="op">&lt;-</span> <span class="va">CO.loc</span><span class="op">[</span><span class="va">good</span>,<span class="op">]</span></span></span>
<span class="r-in"><span><span class="va">Z</span><span class="op">&lt;-</span> <span class="va">CO.elev</span><span class="op">[</span><span class="va">good</span><span class="op">]</span></span></span>
<span class="r-in"><span><span class="va">out</span><span class="op">&lt;-</span> <span class="fu">mKrig</span><span class="op">(</span> <span class="va">xCO</span>,<span class="va">yCO</span>, Z<span class="op">=</span><span class="va">Z</span>, cov.function<span class="op">=</span><span class="st">"stationary.cov"</span>, Covariance<span class="op">=</span><span class="st">"Matern"</span>,</span></span>
<span class="r-in"><span>                    aRange<span class="op">=</span><span class="fl">4.0</span>, smoothness<span class="op">=</span><span class="fl">1.0</span>, lambda<span class="op">=</span><span class="fl">.1</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="set.panel.html">set.panel</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> plot window will lay out plots in a 2 by 1 matrix </span>
<span class="r-in"><span><span class="co"># quilt.plot with elevations</span></span></span>
<span class="r-in"><span><span class="fu"><a href="quilt.plot.html">quilt.plot</a></span><span class="op">(</span> <span class="va">xCO</span>, <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># Smooth surface without elevation linear term included</span></span></span>
<span class="r-in"><span><span class="fu"><a href="fields-internal.html">surface</a></span><span class="op">(</span> <span class="va">out</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="mKrig-2.png" alt="" width="700" height="433"></span>
<span class="r-in"><span><span class="fu"><a href="set.panel.html">set.panel</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> plot window will lay out plots in a 1 by 1 matrix </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">#########################################################################</span></span></span>
<span class="r-in"><span><span class="co"># here is a series of examples with bigger datasets  </span></span></span>
<span class="r-in"><span><span class="co"># using a compactly supported covariance directly</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span> <span class="fl">334</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">N</span><span class="op">&lt;-</span> <span class="fl">1000</span></span></span>
<span class="r-in"><span><span class="va">x</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span> <span class="fl">2</span><span class="op">*</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">N</span><span class="op">)</span><span class="op">-</span><span class="fl">.5</span><span class="op">)</span>,ncol<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">y</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Trig.html" class="external-link">sin</a></span><span class="op">(</span> <span class="fl">1.8</span><span class="op">*</span><span class="va">pi</span><span class="op">*</span><span class="va">x</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/Trig.html" class="external-link">sin</a></span><span class="op">(</span> <span class="fl">2.5</span><span class="op">*</span><span class="va">pi</span><span class="op">*</span><span class="va">x</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span> <span class="fl">1000</span><span class="op">)</span><span class="op">*</span><span class="fl">.1</span></span></span>
<span class="r-in"><span>  </span></span>
<span class="r-in"><span><span class="va">look2</span><span class="op">&lt;-</span><span class="fu">mKrig</span><span class="op">(</span> <span class="va">x</span>,<span class="va">y</span>, cov.function<span class="op">=</span><span class="st">"wendland.cov"</span>,k<span class="op">=</span><span class="fl">2</span>, aRange<span class="op">=</span><span class="fl">.2</span>, </span></span>
<span class="r-in"><span>            lambda<span class="op">=</span><span class="fl">.1</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># take a look at fitted surface</span></span></span>
<span class="r-in"><span><span class="fu"><a href="predictSurface.html">predictSurface</a></span><span class="op">(</span><span class="va">look2</span><span class="op">)</span><span class="op">-&gt;</span> <span class="va">out.p</span></span></span>
<span class="r-in"><span><span class="fu"><a href="fields-internal.html">surface</a></span><span class="op">(</span> <span class="va">out.p</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="mKrig-3.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># this works because the number of nonzero elements within distance aRange</span></span></span>
<span class="r-in"><span><span class="co"># are less than the default maximum allocated size of the </span></span></span>
<span class="r-in"><span><span class="co"># sparse covariance matrix. </span></span></span>
<span class="r-in"><span><span class="co">#  see  options() for the default values. The names follow the convention</span></span></span>
<span class="r-in"><span><span class="co"># spam.arg where arg is the name of the spam component </span></span></span>
<span class="r-in"><span><span class="co">#   e.g. spam.nearestdistnnz</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># The following will give a warning for aRange=.9 because </span></span></span>
<span class="r-in"><span><span class="co"># allocation for the  covariance matirx storage is too small. </span></span></span>
<span class="r-in"><span><span class="co"># Here aRange controls the support of the covariance and so </span></span></span>
<span class="r-in"><span><span class="co"># indirectly the  number of nonzero elements in the sparse matrix</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span> <span class="va">look2</span><span class="op">&lt;-</span> <span class="fu">mKrig</span><span class="op">(</span> <span class="va">x</span>,<span class="va">y</span>, cov.function<span class="op">=</span><span class="st">"wendland.cov"</span>,k<span class="op">=</span><span class="fl">2</span>, aRange<span class="op">=</span><span class="fl">.9</span>, lambda<span class="op">=</span><span class="fl">.1</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># The warning resets the memory allocation  for the covariance matrix</span></span></span>
<span class="r-in"><span><span class="co"># according the to values   options(spam.nearestdistnnz=c(416052,400))'</span></span></span>
<span class="r-in"><span><span class="co"># this is inefficient becuase the preliminary pass failed. </span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># the following call completes the computation in "one pass"</span></span></span>
<span class="r-in"><span><span class="co"># without a warning and without having to reallocate more memory. </span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span> spam.nearestdistnnz<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">416052</span>,<span class="fl">400</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">look2</span><span class="op">&lt;-</span> <span class="fu">mKrig</span><span class="op">(</span> <span class="va">x</span>,<span class="va">y</span>, cov.function<span class="op">=</span><span class="st">"wendland.cov"</span>,k<span class="op">=</span><span class="fl">2</span>,</span></span>
<span class="r-in"><span>                    aRange<span class="op">=</span><span class="fl">.9</span>, lambda<span class="op">=</span><span class="fl">1e-2</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># as a check notice that </span></span></span>
<span class="r-in"><span><span class="co">#   print( look2)</span></span></span>
<span class="r-in"><span><span class="co"># reports the number of nonzero elements consistent with the specifc allocation</span></span></span>
<span class="r-in"><span><span class="co"># increase in spam.options</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># new data set of 1500 locations</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span> <span class="fl">234</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">N</span><span class="op">&lt;-</span> <span class="fl">1500</span></span></span>
<span class="r-in"><span>  <span class="va">x</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span> <span class="fl">2</span><span class="op">*</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">N</span><span class="op">)</span><span class="op">-</span><span class="fl">.5</span><span class="op">)</span>,ncol<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">y</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Trig.html" class="external-link">sin</a></span><span class="op">(</span> <span class="fl">1.8</span><span class="op">*</span><span class="va">pi</span><span class="op">*</span><span class="va">x</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/Trig.html" class="external-link">sin</a></span><span class="op">(</span> <span class="fl">2.5</span><span class="op">*</span><span class="va">pi</span><span class="op">*</span><span class="va">x</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span> <span class="va">N</span><span class="op">)</span><span class="op">*</span><span class="fl">.01</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span>  </span></span>
<span class="r-in"><span><span class="co"># the following is an example of where the allocation  (for nnzR) </span></span></span>
<span class="r-in"><span><span class="co"># for the cholesky factor is too small. A warning is issued and </span></span></span>
<span class="r-in"><span><span class="co"># the allocation is increased by 25</span></span></span>
<span class="r-in"><span><span class="co">#</span></span></span>
<span class="r-in"><span> <span class="va">look2</span><span class="op">&lt;-</span> <span class="fu">mKrig</span><span class="op">(</span> <span class="va">x</span>,<span class="va">y</span>, </span></span>
<span class="r-in"><span>            cov.function<span class="op">=</span><span class="st">"wendland.cov"</span>,k<span class="op">=</span><span class="fl">2</span>, aRange<span class="op">=</span><span class="fl">.1</span>, lambda<span class="op">=</span><span class="fl">1e2</span>  <span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span><span class="co"># to avoid the warning </span></span></span>
<span class="r-in"><span> <span class="va">look2</span><span class="op">&lt;-</span><span class="fu">mKrig</span><span class="op">(</span> <span class="va">x</span>,<span class="va">y</span>, </span></span>
<span class="r-in"><span>            cov.function<span class="op">=</span><span class="st">"wendland.cov"</span>, k<span class="op">=</span><span class="fl">2</span>, aRange<span class="op">=</span><span class="fl">.1</span>, </span></span>
<span class="r-in"><span>            lambda<span class="op">=</span><span class="fl">1e2</span>, chol.args<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>pivot<span class="op">=</span><span class="cn">TRUE</span>, memory<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>nnzR<span class="op">=</span> <span class="fl">450000</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">###############################################################################</span></span></span>
<span class="r-in"><span><span class="co"># fiting multiple data sets</span></span></span>
<span class="r-in"><span><span class="co">#</span></span></span>
<span class="r-in"><span><span class="co">#\dontrun{ </span></span></span>
<span class="r-in"><span>  <span class="va">y1</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Trig.html" class="external-link">sin</a></span><span class="op">(</span> <span class="fl">1.8</span><span class="op">*</span><span class="va">pi</span><span class="op">*</span><span class="va">x</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/Trig.html" class="external-link">sin</a></span><span class="op">(</span> <span class="fl">2.5</span><span class="op">*</span><span class="va">pi</span><span class="op">*</span><span class="va">x</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span> <span class="va">N</span><span class="op">)</span><span class="op">*</span><span class="fl">.01</span></span></span>
<span class="r-in"><span>  <span class="va">y2</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Trig.html" class="external-link">sin</a></span><span class="op">(</span> <span class="fl">1.8</span><span class="op">*</span><span class="va">pi</span><span class="op">*</span><span class="va">x</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/Trig.html" class="external-link">sin</a></span><span class="op">(</span> <span class="fl">2.5</span><span class="op">*</span><span class="va">pi</span><span class="op">*</span><span class="va">x</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span> <span class="va">N</span><span class="op">)</span><span class="op">*</span><span class="fl">.01</span></span></span>
<span class="r-in"><span>  <span class="va">Y</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">y1</span>,<span class="va">y2</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">look3</span><span class="op">&lt;-</span> <span class="fu">mKrig</span><span class="op">(</span> <span class="va">x</span>,<span class="va">Y</span>,cov.function<span class="op">=</span><span class="st">"wendland.cov"</span>,k<span class="op">=</span><span class="fl">2</span>, aRange<span class="op">=</span><span class="fl">.1</span>, </span></span>
<span class="r-in"><span>            lambda<span class="op">=</span><span class="fl">1e2</span>  <span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># note slight difference in summary because two data sets have been fit.</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span> <span class="va">look3</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1]  0.015042946 -0.001902681 -0.026272970</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Call:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> mKrig(x = x, y = Y, cov.function = "wendland.cov", lambda = 100, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     k = 2, aRange = 0.1)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                                                       </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  Number of Locations:                           1500  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  Number of data sets fit:                       2     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  Degree of polynomial null space ( base model): 1     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  Total number of parameters in base model       3     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   Estimate Eff. degrees of freedom              17.99 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      Standard Error of Eff. Df                  0.5135</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  Smoothing parameter                            100   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  Nonzero entries in covariance                  18614 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Summary of fixed effects</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     estimate       SE pValue</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> d1  0.015040 0.009545 0.1150</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> d2 -0.001903 0.016670 0.9091</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> d3 -0.026270 0.016320 0.1074</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Covariance Model: wendland.cov</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    Non-default covariance arguments and their values </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    Argument: k  has the value(s): </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] 2</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    Argument: aRange  has the value(s): </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] 0.1</span>
<span class="r-in"><span><span class="co">#}</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span><span class="co">##################################################################</span></span></span>
<span class="r-in"><span><span class="co"># finding a good choice for aRange as a taper </span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Suppose the target is a spatial prediction using roughly 50 nearest neighbors</span></span></span>
<span class="r-in"><span><span class="co"># (tapering covariances is effective for roughly 20 or more in the situation of </span></span></span>
<span class="r-in"><span><span class="co">#  interpolation) see Furrer, Genton and Nychka (2006).</span></span></span>
<span class="r-in"><span><span class="co"># take a look at a random set of 100 points to get idea of scale</span></span></span>
<span class="r-in"><span><span class="co"># and saving  computation time by not  looking at the complete set</span></span></span>
<span class="r-in"><span><span class="co"># of points</span></span></span>
<span class="r-in"><span><span class="co"># NOTE: This could also be done directly using the  FNN package for finding nearest </span></span></span>
<span class="r-in"><span><span class="co"># neighbors</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">223</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">ind</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span> <span class="fl">1</span><span class="op">:</span><span class="va">N</span>,<span class="fl">100</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">hold</span><span class="op">&lt;-</span> <span class="fu"><a href="rdist.html">rdist</a></span><span class="op">(</span> <span class="va">x</span><span class="op">[</span><span class="va">ind</span>,<span class="op">]</span>, <span class="va">x</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">dd</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span> <span class="va">hold</span>, <span class="fl">1</span>, <span class="va">quantile</span>, p<span class="op">=</span> <span class="fl">50</span><span class="op">/</span><span class="va">N</span> <span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">dguess</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">dd</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># dguess is now a reasonable guess at finding cutoff distance for</span></span></span>
<span class="r-in"><span><span class="co"># 50 or so neighbors</span></span></span>
<span class="r-in"><span><span class="co"># full distance matrix excluding distances greater than dguess</span></span></span>
<span class="r-in"><span>  <span class="va">hold2</span><span class="op">&lt;-</span> <span class="fu">nearest.dist</span><span class="op">(</span> <span class="va">x</span>, <span class="va">x</span>, delta<span class="op">=</span> <span class="va">dguess</span> <span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># here is trick to find the number of nonsero rows for a matrix in spam format. </span></span></span>
<span class="r-in"><span>  <span class="va">hold3</span><span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/diff.html" class="external-link">diff</a></span><span class="op">(</span> <span class="va">hold2</span><span class="op">@</span><span class="va">rowpointers</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co">#  min( hold3) = 43   which we declare close enough. This also counts the diagonal</span></span></span>
<span class="r-in"><span><span class="co"># So there are a minimum of 42 nearest neighbors  ( median is 136)</span></span></span>
<span class="r-in"><span><span class="co"># see  table( hold3) for the distribution </span></span></span>
<span class="r-in"><span><span class="co"># now the following will use no less than 43 - 1  nearest neighbors </span></span></span>
<span class="r-in"><span><span class="co"># due to the tapering. </span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="fu">mKrig</span><span class="op">(</span> <span class="va">x</span>,<span class="va">y</span>, cov.function<span class="op">=</span><span class="st">"wendland.cov"</span>,k<span class="op">=</span><span class="fl">2</span>, aRange<span class="op">=</span><span class="va">dguess</span>, </span></span>
<span class="r-in"><span>            lambda<span class="op">=</span><span class="fl">1e2</span><span class="op">)</span> <span class="op">-&gt;</span>  <span class="va">look2</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">###############################################################################</span></span></span>
<span class="r-in"><span><span class="co"># use precomputed distance matrix</span></span></span>
<span class="r-in"><span><span class="co">#</span></span></span>
<span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span> </span></span>
<span class="r-in"><span>  <span class="va">y1</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Trig.html" class="external-link">sin</a></span><span class="op">(</span> <span class="fl">1.8</span><span class="op">*</span><span class="va">pi</span><span class="op">*</span><span class="va">x</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/Trig.html" class="external-link">sin</a></span><span class="op">(</span> <span class="fl">2.5</span><span class="op">*</span><span class="va">pi</span><span class="op">*</span><span class="va">x</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span> <span class="va">N</span><span class="op">)</span><span class="op">*</span><span class="fl">.01</span></span></span>
<span class="r-in"><span>  <span class="va">y2</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Trig.html" class="external-link">sin</a></span><span class="op">(</span> <span class="fl">1.8</span><span class="op">*</span><span class="va">pi</span><span class="op">*</span><span class="va">x</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/Trig.html" class="external-link">sin</a></span><span class="op">(</span> <span class="fl">2.5</span><span class="op">*</span><span class="va">pi</span><span class="op">*</span><span class="va">x</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span> <span class="va">N</span><span class="op">)</span><span class="op">*</span><span class="fl">.01</span></span></span>
<span class="r-in"><span>  <span class="va">Y</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">y1</span>,<span class="va">y2</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="co">#precompute distance matrix in compact form</span></span></span>
<span class="r-in"><span>  <span class="va">distMat</span> <span class="op">=</span> <span class="fu"><a href="rdist.html">rdist</a></span><span class="op">(</span><span class="va">x</span>, compact<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">look3</span><span class="op">&lt;-</span> <span class="fu">mKrig</span><span class="op">(</span> <span class="va">x</span>,<span class="va">Y</span>,cov.function<span class="op">=</span><span class="st">"stationary.cov"</span>, aRange<span class="op">=</span><span class="fl">.1</span>, </span></span>
<span class="r-in"><span>            lambda<span class="op">=</span><span class="fl">1e2</span>, distMat<span class="op">=</span><span class="va">distMat</span> <span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="co">#precompute distance matrix in standard form</span></span></span>
<span class="r-in"><span>  <span class="va">distMat</span> <span class="op">=</span> <span class="fu"><a href="rdist.html">rdist</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">look3</span><span class="op">&lt;-</span> <span class="fu">mKrig</span><span class="op">(</span> <span class="va">x</span>,<span class="va">Y</span>,cov.function<span class="op">=</span><span class="st">"stationary.cov"</span>, aRange<span class="op">=</span><span class="fl">.1</span>, </span></span>
<span class="r-in"><span>            lambda<span class="op">=</span><span class="fl">1e2</span>, distMat<span class="op">=</span><span class="va">distMat</span> <span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
</code></pre></div>
    </div>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top"><h2 data-toc-skip>Contents</h2>
    </nav></div>
</div>


      <footer><div class="copyright">
  <p></p><p>Developed by Douglas Nychka, Reinhard Furrer, John Paige, Stephan Sain, Florian Gerber, Matthew Iverson.</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer></div>

  


  

  </body></html>

