<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>
Robust and Quantile smoothing using a thin-plate spline — QTps • fields</title><!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous"><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css"><script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../pkgdown.js"></script><meta property="og:title" content="
Robust and Quantile smoothing using a thin-plate spline — QTps"><meta property="og:description" content="
This function uses the standard thin plate spline function Tps and a algorithm based on 
psuedo data to compute robust smoothers based on the Huber weight function. By modifying the 
symmetry of the Huber function and changing the scale one can also approximate a quantile 
smoother. This function is experimental in that is not clear how efficient the psuedo-data
algorithm is acheiving convergence to a solution."><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body data-spy="scroll" data-target="#toc">
    

    <div class="container template-reference-topic">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">fields</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">14.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu"><li>
      <a href="../articles/Tps.html">Tps usage illustration</a>
    </li>
    <li>
      <a href="../articles/predictSurface.html">predictSurface</a>
    </li>
  </ul></li>
      </ul><ul class="nav navbar-nav navbar-right"><li>
  <a href="https://github.com/dnychka/fieldsRPackage/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1><!-- %%  ~~function to do ... ~~ -->
Robust and Quantile smoothing using a thin-plate spline</h1>
    
    <div class="hidden name"><code>QTps.Rd</code></div>
    </div>

    <div class="ref-description">
    <p><!-- %%  ~~ A concise (1-5 lines) description of what the function does. ~~ -->
This function uses the standard thin plate spline function <code>Tps</code> and a algorithm based on 
psuedo data to compute robust smoothers based on the Huber weight function. By modifying the 
symmetry of the Huber function and changing the scale one can also approximate a quantile 
smoother. This function is experimental in that is not clear how efficient the psuedo-data
algorithm is acheiving convergence to a solution.</p>
    </div>

    <div id="ref-usage">
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">QTps</span><span class="op">(</span><span class="va">x</span>, <span class="va">Y</span>, <span class="va">...</span>, f.start <span class="op">=</span> <span class="cn">NULL</span>, psi.scale <span class="op">=</span> <span class="cn">NULL</span>, C <span class="op">=</span> <span class="fl">1</span>, alpha <span class="op">=</span> <span class="fl">0.5</span>, Niterations <span class="op">=</span> <span class="fl">100</span>,</span>
<span>               tolerance <span class="op">=</span> <span class="fl">0.001</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu">QSreg</span><span class="op">(</span><span class="va">x</span>, <span class="va">Y</span>, lambda <span class="op">=</span> <span class="cn">NA</span>, f.start <span class="op">=</span> <span class="cn">NULL</span>, psi.scale <span class="op">=</span> <span class="cn">NULL</span>, </span>
<span>    C <span class="op">=</span> <span class="fl">1</span>, alpha <span class="op">=</span> <span class="fl">0.5</span>, Niterations <span class="op">=</span> <span class="fl">100</span>, tolerance <span class="op">=</span> <span class="fl">0.001</span>, </span>
<span>    verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div id="arguments">
    <h2>Arguments</h2>
    <dl><dt>x</dt>
<dd><p>Locations of observations.</p></dd>

  <dt>Y</dt>
<dd><p>Observations</p></dd>

<dt>lambda</dt>
<dd><p>Value of the smoothing parameter. If NA found by an approximate corss-validation criterion.</p></dd>


  <dt>...</dt>
<dd><p>Any other arguments to pass to the Tps function, which are then passed to the Krig function. <code> give.warnings =FALSE</code> can be used to turn off pesky warnings when not important (see example below).</p></dd>

  <dt>C</dt>
<dd><p>Scaling for huber robust weighting function. (See below.) Usually it is better to leave this at 1 and 
just modify the scale  <code>psi.scale</code> according to the size of the residuals.</p></dd>

  <dt>f.start</dt>
<dd><p>The initial value for the estimated function. If NULL then the constant function at the 
median of <code>Y</code> will be used. NOTE: This may not be a very good starting vector and a more robust
method would be to use a local robust smoother.</p></dd>

  <dt>psi.scale</dt>
<dd><p>The scale value for the Huber function.  When C=1, this is the point where the Huber weight function will 
change from quadratic to linear. Default is to use the scale <code>.05*mad(Y)</code>  and <code>C=1</code> . Very small scales relative to the 
size of the residuals will cause the estimate to approximate a quantile spline. Very large scales will yield the
ordinary least squares spline.</p></dd>

  <dt>alpha</dt>
<dd><p>The quantile that is estimated by the spline. Default is .5 giving a median. Equivalently this parameter controls the slope of the linear wings in the Huber function  <code>2*alpha</code> for the positive wing and  <code>2*(1-alpha)</code>
for the negative wing.</p></dd>

  <dt>Niterations</dt>
<dd><p>Maximum number of interations of the psuedo data algorithm</p></dd>

  <dt>tolerance</dt>
<dd><p>Convergence criterion based on the relative change in the predicted values of the function estimate. Specifically if the criterion <code>mean(abs(f.hat.new - f.hat))/mean(abs(f.hat))</code> is less than  <code>tolerance</code> the iterations re stopped.</p></dd>

  <dt>verbose</dt>
<dd><p>If TRUE intermediate results are printed out.</p></dd>

</dl></div>
    <div id="details">
    <h2>Details</h2>
    <p>These are experimental functions that use the psuedo-value algorithm to compute a class of robust and quantile problems.  <code>QTps</code> use the <code>Tps</code> function as its least squares base smoother while <code>QSreg</code> uses the efficient <code>sreg</code> for 1-D cubic smoothing spline models. Currently for the 1-d spline problem we recommend using the (or at least comparing to ) the old <code>qsreg</code> function. <code>QSreg</code> was created to produce a more readable version of the 1-d method that follows the thin plate spline format.</p>
<p>The Thin Plate Spline/ Kriging model through fields is: Y.k= f(x.k) = P(x.k) + Z(x.k) + e.k</p>
<p>with the goal of estimating the smooth function: f(x)= P(x) + Z(x)</p>
<p>The extension in this function is that e.k can be heavy tailed or have outliers and one would still like a 
robust estimate of f(x). In the quantile approximation (very small scale parameter) f(x) is an estimate of the 
alpha quantile of the conditional distribution of Y given x.</p>
<p>The algorithm is iterative and involves at each step tapering the residuals in a nonlinear way. 
Let psi.wght  be this tapering function then given an initial estimate of f, f.hat the new data for smoothing is</p>
<p><code> Y.psuedo&lt;- f.hat + psi.scale* psi.wght( Y - f.hat, psi.scale=psi.scale, alpha=alpha)</code> 
A thin plate spline is now estimated for these data and a new prediction for f is found. This new vector is
used to define new psuedo values. Convergence is achieved when the the subsequent estimates of f.hat do not
change between interations. The advantage of this algorithm is at every step a standard "least squares" thin
plate spline is fit to the psuedo data. Because only the observation vector is changing at each iteration 
Some matrix decompositions need only be found once and the computations at each subsequent iteration are efficient.
At convergence there is some asymptotic theory to suggest that the psuedo data can be fit using the least
squares spline and the standard smoothing techinques are valid. For example one can consider looking at the
cross-validation function for the psuedo-data as a robust version to select a smoothing parameter. This approach
is different from the weighted least squared algorithm used in the <code>qsreg</code> function. Also <code>qsreg</code> is only
designed to work with 1-d cubic smoothing splines.</p>
<p>The  "sigma" function indicating the departure from a pure quadratic loss function  has the definition</p><div class="sourceCode"><pre><code><span></span>
<span><span class="va">qsreg.sigma</span><span class="op">&lt;-</span><span class="kw">function</span><span class="op">(</span><span class="va">r</span>, <span class="va">alpha</span> <span class="op">=</span> <span class="fl">0.5</span>, <span class="va">C</span> <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> </span>
<span>     <span class="va">temp</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span> <span class="va">r</span><span class="op">&lt;</span> <span class="fl">0</span>, <span class="op">(</span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">alpha</span><span class="op">)</span> <span class="op">*</span> <span class="va">r</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="va">C</span> ,  <span class="op">(</span><span class="va">alpha</span> <span class="op">*</span> <span class="va">r</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="va">C</span><span class="op">)</span></span>
<span>     <span class="va">temp</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span> <span class="va">r</span> <span class="op">&gt;</span><span class="va">C</span>,   <span class="fl">2</span> <span class="op">*</span> <span class="va">alpha</span> <span class="op">*</span> <span class="va">r</span> <span class="op">-</span> <span class="va">alpha</span> <span class="op">*</span> <span class="va">C</span>, <span class="va">temp</span><span class="op">)</span></span>
<span>     <span class="va">temp</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span> <span class="va">r</span> <span class="op">&lt;</span> <span class="op">-</span><span class="va">C</span>, <span class="op">-</span><span class="fl">2</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">alpha</span><span class="op">)</span> <span class="op">*</span> <span class="va">r</span> <span class="op">-</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">alpha</span><span class="op">)</span> <span class="op">*</span> <span class="va">C</span>, <span class="va">temp</span><span class="op">)</span></span>
<span>     <span class="va">temp</span></span></code></pre></div> 

<p>The derivative of this function "psi" is</p>
<div class="sourceCode"><pre><code><span></span>
<span> <span class="va">qsreg.psi</span><span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">r</span>, <span class="va">alpha</span> <span class="op">=</span> <span class="fl">0.5</span>, <span class="va">C</span> <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>     <span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span> <span class="va">r</span> <span class="op">&lt;</span> <span class="fl">0</span>, <span class="fl">2</span><span class="op">*</span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">alpha</span><span class="op">)</span><span class="op">*</span> <span class="va">r</span><span class="op">/</span><span class="va">C</span>, <span class="fl">2</span><span class="op">*</span><span class="va">alpha</span> <span class="op">*</span> <span class="va">r</span><span class="op">/</span><span class="va">C</span> <span class="op">)</span>               </span>
<span>     <span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span> <span class="va">temp</span> <span class="op">&gt;</span> <span class="fl">2</span><span class="op">*</span><span class="va">alpha</span>, <span class="fl">2</span><span class="op">*</span><span class="va">alpha</span>, <span class="va">temp</span><span class="op">)</span></span>
<span>     <span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span> <span class="va">temp</span> <span class="op">&lt;</span> <span class="op">-</span><span class="fl">2</span><span class="op">*</span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">alpha</span><span class="op">)</span>, <span class="op">-</span><span class="fl">2</span><span class="op">*</span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">alpha</span><span class="op">)</span>, <span class="va">temp</span><span class="op">)</span></span>
<span>     <span class="va">temp</span></span></code></pre></div>

<p>Note that if C is very small and if alpha = .5 then psi will essentially be 1 for r &gt; 0 and -1 for  r &lt; 0. 
The key feature here is that outside a ceratin range the residual is
truncated to a constant value. This is similar
 to the Windsorizing operation in classical robust statistics.</p>
<p>Another advantage of the psuedo data algotrithm is that at convergence
one can just apply all the usual 
generic functions from Tps to the psuedo data fit. For example,
predict, surface, print, etc. Some additional
components are added to the Krig/Tps  object, however, for information
about the iterations and original data. 
Note that currently these are not reported in the summaries and
printing of the output object.</p>


    </div>
    <div id="value">
    <h2>Value</h2>
    

<p>A <code>Krig</code> object with additional components:</p>
<dl><dt>yraw</dt>
<dd><p>Original Y values</p></dd>

  <dt>conv.info</dt>
<dd><p>A vector giving the convergence criterion at each
  iteration.</p></dd>

 <dt>conv.flag</dt>
<dd><p>If TRUE then convergence criterion was less than
 the tolerance value.</p></dd>

 <dt>psi.scale</dt>
<dd><p>Scaling factor used for the psi.wght function.</p></dd>

  <dt>value</dt>
<dd><p>Value of alpha.</p></dd>

</dl></div>
    <div id="references">
    <h2>References</h2>
    <p>Oh, Hee-Seok, Thomas CM Lee, and Douglas W. Nychka. 
"Fast nonparametric quantile regression with arbitrary smoothing methods." Journal of Computational and Graphical Statistics 20.2 (2011): 510-526.</p>
    </div>
    <div id="author">
    <h2>Author</h2>
    <p>Doug Nychka</p>
    </div>
    <div id="see-also">
    <h2>See also</h2>
    <div class="dont-index"><p>qsreg</p></div>
    </div>

    <div id="ref-examples">
    <h2>Examples</h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">ozone2</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">x</span><span class="op">&lt;-</span> <span class="va">ozone2</span><span class="op">$</span><span class="va">lon.lat</span></span></span>
<span class="r-in"><span><span class="va">y</span><span class="op">&lt;-</span> <span class="va">ozone2</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="fl">16</span>,<span class="op">]</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Smoothing fixed at 50 df </span></span></span>
<span class="r-in"><span>    <span class="va">look1</span><span class="op">&lt;-</span> <span class="fu">QTps</span><span class="op">(</span> <span class="va">x</span>,<span class="va">y</span>, psi.scale<span class="op">=</span> <span class="fl">15</span>, df<span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span></span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>6 missing value(s) removed from data</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span><span class="co"># Least squares spline (because scale is so large)</span></span></span>
<span class="r-in"><span>    <span class="va">look2</span><span class="op">&lt;-</span> <span class="fu">QTps</span><span class="op">(</span> <span class="va">x</span>,<span class="va">y</span>, psi.scale<span class="op">=</span> <span class="fl">100</span>, df<span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co">#</span></span></span>
<span class="r-in"><span>    <span class="va">y.outlier</span><span class="op">&lt;-</span> <span class="va">y</span></span></span>
<span class="r-in"><span><span class="co"># add in a huge outlier.</span></span></span>
<span class="r-in"><span>    <span class="va">y.outlier</span><span class="op">[</span><span class="fl">58</span><span class="op">]</span><span class="op">&lt;-</span> <span class="fl">1e5</span></span></span>
<span class="r-in"><span>    <span class="va">look.outlier1</span><span class="op">&lt;-</span> <span class="fu">QTps</span><span class="op">(</span> <span class="va">x</span>,<span class="va">y.outlier</span>, psi.scale<span class="op">=</span> <span class="fl">15</span>, df<span class="op">=</span> <span class="fl">50</span>,</span></span>
<span class="r-in"><span>                           give.warnings<span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># least squares spline.</span></span></span>
<span class="r-in"><span>    <span class="va">look.outlier2</span><span class="op">&lt;-</span> <span class="fu">QTps</span><span class="op">(</span> <span class="va">x</span>,<span class="va">y.outlier</span>, psi.scale<span class="op">=</span><span class="fl">100</span> , df<span class="op">=</span> <span class="fl">50</span>,</span></span>
<span class="r-in"><span>                           give.warnings<span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co">#</span></span></span>
<span class="r-in"><span>    <span class="fu"><a href="set.panel.html">set.panel</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">2</span><span class="op">)</span></span></span>
<span class="r-in"><span>    <span class="fu"><a href="fields-internal.html">surface</a></span><span class="op">(</span> <span class="va">look1</span><span class="op">)</span></span></span>
<span class="r-in"><span>    <span class="fu"><a href="https://rdrr.io/r/graphics/title.html" class="external-link">title</a></span><span class="op">(</span><span class="st">"robust spline"</span><span class="op">)</span></span></span>
<span class="r-in"><span>    <span class="fu"><a href="fields-internal.html">surface</a></span><span class="op">(</span> <span class="va">look2</span><span class="op">)</span></span></span>
<span class="r-in"><span>    <span class="fu"><a href="https://rdrr.io/r/graphics/title.html" class="external-link">title</a></span><span class="op">(</span><span class="st">"least squares spline"</span><span class="op">)</span></span></span>
<span class="r-in"><span>    <span class="fu"><a href="fields-internal.html">surface</a></span><span class="op">(</span> <span class="va">look.outlier1</span>,  zlim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">250</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span>    <span class="fu"><a href="https://rdrr.io/r/graphics/title.html" class="external-link">title</a></span><span class="op">(</span><span class="st">"robust spline w/outlier"</span><span class="op">)</span> </span></span>
<span class="r-in"><span>    <span class="fu"><a href="https://rdrr.io/r/graphics/points.html" class="external-link">points</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">58</span>,<span class="op">]</span><span class="op">)</span>, pch<span class="op">=</span><span class="st">"+"</span><span class="op">)</span></span></span>
<span class="r-in"><span>    <span class="fu"><a href="fields-internal.html">surface</a></span><span class="op">(</span> <span class="va">look.outlier2</span>, zlim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">250</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span>    <span class="fu"><a href="https://rdrr.io/r/graphics/title.html" class="external-link">title</a></span><span class="op">(</span><span class="st">"least squares spline w/outlier"</span><span class="op">)</span></span></span>
<span class="r-in"><span>    <span class="fu"><a href="https://rdrr.io/r/graphics/points.html" class="external-link">points</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">58</span>,<span class="op">]</span><span class="op">)</span>, pch<span class="op">=</span><span class="st">"+"</span><span class="op">)</span></span></span>
<span class="r-in"><span>    <span class="fu"><a href="set.panel.html">set.panel</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span><span class="co"># some quantiles</span></span></span>
<span class="r-in"><span><span class="va">look50</span> <span class="op">&lt;-</span> <span class="fu">QTps</span><span class="op">(</span> <span class="va">x</span>,<span class="va">y</span>, psi.scale<span class="op">=</span><span class="fl">.5</span>,<span class="op">)</span></span></span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>6 missing value(s) removed from data</span>
<span class="r-in"><span><span class="va">look75</span> <span class="op">&lt;-</span> <span class="fu">QTps</span><span class="op">(</span> <span class="va">x</span>,<span class="va">y</span>,f.start<span class="op">=</span> <span class="va">look50</span><span class="op">$</span><span class="va">fitted.values</span>, alpha<span class="op">=</span><span class="fl">.75</span><span class="op">)</span></span></span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>6 missing value(s) removed from data</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># a simulated example that finds some different quantiles. </span></span></span>
<span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">N</span><span class="op">&lt;-</span> <span class="fl">400</span></span></span>
<span class="r-in"><span><span class="va">x</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span> <span class="va">N</span><span class="op">)</span>, ncol<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">true.g</span><span class="op">&lt;-</span> <span class="va">x</span> <span class="op">*</span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">x</span><span class="op">)</span><span class="op">*</span><span class="fl">2</span></span></span>
<span class="r-in"><span><span class="va">true.g</span><span class="op">&lt;-</span> <span class="va">true.g</span><span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span> <span class="va">true.g</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">y</span><span class="op">&lt;-</span>  <span class="va">true.g</span> <span class="op">+</span> <span class="fl">.2</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span> <span class="va">N</span> <span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">look0</span> <span class="op">&lt;-</span> <span class="fu">QTps</span><span class="op">(</span> <span class="va">x</span>,<span class="va">y</span>, psi.scale<span class="op">=</span><span class="fl">10</span>, df<span class="op">=</span> <span class="fl">15</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">look50</span> <span class="op">&lt;-</span> <span class="fu">QTps</span><span class="op">(</span> <span class="va">x</span>,<span class="va">y</span>, df<span class="op">=</span><span class="fl">15</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">look75</span> <span class="op">&lt;-</span> <span class="fu">QTps</span><span class="op">(</span> <span class="va">x</span>,<span class="va">y</span>,f.start<span class="op">=</span> <span class="va">look50</span><span class="op">$</span><span class="va">fitted.values</span>, df<span class="op">=</span><span class="fl">15</span>, alpha<span class="op">=</span><span class="fl">.75</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span><span class="co"># this example tests the quantile estimate by Monte Carlo</span></span></span>
<span class="r-in"><span><span class="co"># by creating many replicate points to increase the sample size. </span></span></span>
<span class="r-in"><span><span class="co"># Replicate points are used because the computations for the </span></span></span>
<span class="r-in"><span><span class="co"># spline are dominated by the number of unique locations not the </span></span></span>
<span class="r-in"><span><span class="co"># total number of points. </span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">N</span><span class="op">&lt;-</span> <span class="fl">80</span></span></span>
<span class="r-in"><span><span class="va">M</span><span class="op">&lt;-</span> <span class="fl">200</span></span></span>
<span class="r-in"><span><span class="va">x</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span> <span class="va">N</span><span class="op">)</span><span class="op">)</span>, ncol<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">x</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span> <span class="va">x</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>,<span class="va">M</span><span class="op">)</span>, ncol<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">true.g</span><span class="op">&lt;-</span> <span class="va">x</span> <span class="op">*</span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">x</span><span class="op">)</span><span class="op">*</span><span class="fl">2</span></span></span>
<span class="r-in"><span><span class="va">true.g</span><span class="op">&lt;-</span> <span class="va">true.g</span><span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span> <span class="va">true.g</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">errors</span><span class="op">&lt;-</span> <span class="fl">.2</span><span class="op">*</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html" class="external-link">rexp</a></span><span class="op">(</span> <span class="va">N</span><span class="op">*</span><span class="va">M</span><span class="op">)</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">y</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="va">true.g</span>, ncol<span class="op">=</span><span class="va">M</span>, nrow<span class="op">=</span><span class="va">N</span><span class="op">)</span> <span class="op">+</span> <span class="fl">.2</span> <span class="op">*</span>  <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span> <span class="va">errors</span>, ncol<span class="op">=</span><span class="va">M</span>, nrow<span class="op">=</span><span class="va">N</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">look0</span> <span class="op">&lt;-</span> <span class="fu">QTps</span><span class="op">(</span> <span class="va">x</span>,<span class="va">y</span>, psi.scale<span class="op">=</span><span class="fl">10</span>, df<span class="op">=</span> <span class="fl">15</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">look50</span> <span class="op">&lt;-</span> <span class="fu">QTps</span><span class="op">(</span> <span class="va">x</span>,<span class="va">y</span>, df<span class="op">=</span><span class="fl">15</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">look75</span> <span class="op">&lt;-</span> <span class="fu">QTps</span><span class="op">(</span> <span class="va">x</span>,<span class="va">y</span>, df<span class="op">=</span><span class="fl">15</span>, alpha<span class="op">=</span><span class="fl">.75</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu"><a href="bplot.xy.html">bplot.xy</a></span><span class="op">(</span><span class="va">x</span>,<span class="va">y</span>, N<span class="op">=</span><span class="fl">25</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">xg</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,,<span class="fl">200</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span> <span class="va">xg</span>, <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span> <span class="va">look0</span>, x<span class="op">=</span><span class="va">xg</span><span class="op">)</span>, col<span class="op">=</span><span class="st">"red"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span> <span class="va">xg</span>, <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span> <span class="va">look50</span>, x<span class="op">=</span><span class="va">xg</span><span class="op">)</span>, col<span class="op">=</span><span class="st">"blue"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span> <span class="va">xg</span>, <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span> <span class="va">look75</span>, x<span class="op">=</span><span class="va">xg</span><span class="op">)</span>, col<span class="op">=</span><span class="st">"green"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span><span class="co"># A comparison with qsreg</span></span></span>
<span class="r-in"><span>  <span class="va">qsreg.fit50</span><span class="op">&lt;-</span> <span class="fu"><a href="qsreg.html">qsreg</a></span><span class="op">(</span><span class="va">rat.diet</span><span class="op">$</span><span class="va">t</span>,<span class="va">rat.diet</span><span class="op">$</span><span class="va">con</span>, sc<span class="op">=</span><span class="fl">.5</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">lam</span><span class="op">&lt;-</span> <span class="va">qsreg.fit50</span><span class="op">$</span><span class="va">cv.grid</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span></span></span>
<span class="r-in"><span>  <span class="va">df</span><span class="op">&lt;-</span> <span class="va">qsreg.fit50</span><span class="op">$</span><span class="va">cv.grid</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span></span></span>
<span class="r-in"><span>  <span class="va">M</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">lam</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">CV</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span> <span class="cn">NA</span>, <span class="va">M</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">M</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span> <span class="va">df</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">fhat.old</span><span class="op">&lt;-</span> <span class="cn">NULL</span></span></span>
<span class="r-in"><span>  <span class="kw">for</span> <span class="op">(</span> <span class="va">k</span> <span class="kw">in</span> <span class="va">M</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span><span class="op">{</span></span></span>
<span class="r-in"><span>     <span class="va">temp.obj</span><span class="op">&lt;-</span> <span class="fu">QTps</span><span class="op">(</span><span class="va">rat.diet</span><span class="op">$</span><span class="va">t</span>,<span class="va">rat.diet</span><span class="op">$</span><span class="va">con</span>, f.start<span class="op">=</span><span class="va">fhat.old</span>,  psi.scale<span class="op">=</span><span class="fl">.5</span>, tolerance<span class="op">=</span><span class="fl">1e-6</span>,</span></span>
<span class="r-in"><span>     verbose<span class="op">=</span><span class="cn">FALSE</span>, df<span class="op">=</span> <span class="va">df</span><span class="op">[</span><span class="va">k</span><span class="op">]</span>,</span></span>
<span class="r-in"><span>     give.warnings<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span> </span></span>
<span class="r-in"><span>     <span class="co"># avoids warnings from Krig search on lambda</span></span></span>
<span class="r-in"><span>     <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="va">k</span>, <span class="st">" "</span><span class="op">)</span></span></span>
<span class="r-in"><span>     <span class="va">CV</span><span class="op">[</span><span class="va">k</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">temp.obj</span><span class="op">$</span><span class="va">Qinfo</span><span class="op">$</span><span class="va">CV.psuedo</span></span></span>
<span class="r-in"><span>     <span class="va">fhat.old</span><span class="op">&lt;-</span> <span class="va">temp.obj</span><span class="op">$</span><span class="va">fitted.values</span></span></span>
<span class="r-in"><span>  <span class="op">}</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span> <span class="va">df</span>, <span class="va">CV</span>, type<span class="op">=</span><span class="st">"l"</span>, lwd<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># psuedo data estimate</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/graphics/points.html" class="external-link">points</a></span><span class="op">(</span> <span class="va">qsreg.fit50</span><span class="op">$</span><span class="va">cv.grid</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>,<span class="fl">6</span><span class="op">)</span><span class="op">]</span>, col<span class="op">=</span><span class="st">"blue"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># alternative CV estimate via reweighted LS</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/graphics/points.html" class="external-link">points</a></span><span class="op">(</span> <span class="va">qsreg.fit50</span><span class="op">$</span><span class="va">cv.grid</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">3</span><span class="op">)</span><span class="op">]</span>, col<span class="op">=</span><span class="st">"red"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top"><h2 data-toc-skip>Contents</h2>
    </nav></div>
</div>


      <footer><div class="copyright">
  <p></p><p>Developed by Douglas Nychka, Reinhard Furrer, John Paige, Stephan Sain, Florian Gerber, Matthew Iverson.</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer></div>

  


  

  </body></html>

